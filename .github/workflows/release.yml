name: Release

on:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    name: Create Release PR
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.major }}.${{ steps.release.outputs.minor }}.${{ steps.release.outputs.patch }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          release-type: dart

  build-macos:
    name: Build macOS App
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Generate app icons
        run: dart run flutter_launcher_icons

      - name: Build macOS app
        run: flutter build macos --release

      - name: Create ZIP
        run: |
          VERSION=${{ needs.release-please.outputs.version }}

          # Find the app bundle
          APP_PATH=$(find build/macos/Build/Products/Release -name "*.app" -type d -maxdepth 1 | head -n 1)
          APP_NAME=$(basename "$APP_PATH")
          echo "Using app at: $APP_PATH"

          # Create ZIP from app bundle
          cd "$(dirname "$APP_PATH")"
          zip -r "Swaloka-Looping-Tool-${VERSION}-macos.zip" "$APP_NAME"
          mv "Swaloka-Looping-Tool-${VERSION}-macos.zip" "${GITHUB_WORKSPACE}/build/"

      - name: Upload ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-zip
          path: build/Swaloka-Looping-Tool-*-macos.zip
          retention-days: 1

  build-windows:
    name: Build Windows App
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Generate app icons
        run: dart run flutter_launcher_icons

      - name: Build Windows app
        run: flutter build windows --release

      - name: Download VC++ Redistributable
        run: |
          # Download Microsoft Visual C++ Redistributable (required for FFmpeg and native libs)
          Invoke-WebRequest -Uri "https://aka.ms/vs/17/release/vc_redist.x64.exe" -OutFile "windows/vc_redist.x64.exe"
          Write-Host "âœ… Downloaded VC++ Redistributable"

      - name: Create EXE installer with Inno Setup
        run: |
          $VERSION = "${{ needs.release-please.outputs.version }}"

          # Update version in installer script
          $issContent = Get-Content "windows/installer_script.iss" -Raw
          $issContent = $issContent -replace "AppVersion=.*", "AppVersion=$VERSION"
          $issContent = $issContent -replace "OutputBaseFilename=.*", "OutputBaseFilename=Swaloka-Looping-Tool-$VERSION-windows-installer"
          Set-Content "windows/installer_script.iss" $issContent

          # Build installer using Inno Setup
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "windows\installer_script.iss"

          # Move installer to build folder
          Move-Item "Swaloka-Looping-Tool-$VERSION-windows-installer.exe" "build/"

      - name: Upload EXE installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: build/Swaloka-Looping-Tool-*-windows-installer.exe
          retention-days: 1

  build-linux:
    name: Build Linux App
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev libasound2-dev libfuse2 libmpv-dev

      - name: Install dependencies
        run: flutter pub get

      - name: Generate app icons
        run: dart run flutter_launcher_icons

      - name: Build Linux app
        run: flutter build linux --release

      - name: Create tar.gz archive
        run: |
          VERSION=${{ needs.release-please.outputs.version }}

          # Navigate to build directory
          cd build/linux/x64/release/bundle

          # Create tar.gz archive
          tar -czf "Swaloka-Looping-Tool-${VERSION}-linux-x64.tar.gz" *

          # Move to build root
          mv "Swaloka-Looping-Tool-${VERSION}-linux-x64.tar.gz" "${GITHUB_WORKSPACE}/build/"

      - name: Create AppImage
        run: |
          VERSION=${{ needs.release-please.outputs.version }}

          # Download appimagetool
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage -O appimagetool
          chmod +x appimagetool

          # Create AppDir structure
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/lib
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps

          # Copy the Flutter app bundle
          cp -r build/linux/x64/release/bundle/* AppDir/usr/bin/

          # Copy icon
          cp assets/logo.png AppDir/usr/share/icons/hicolor/256x256/apps/swaloka-looping-tool.png
          cp assets/logo.png AppDir/swaloka-looping-tool.png

          # Create desktop file
          cat > AppDir/swaloka-looping-tool.desktop << 'DESKTOP'
          [Desktop Entry]
          Name=Swaloka Looping Tool
          Comment=Video looping and merging tool
          Exec=swaloka_looping_tool
          Icon=swaloka-looping-tool
          Type=Application
          Categories=AudioVideo;Video;
          Terminal=false
          DESKTOP

          # Create AppRun script
          cat > AppDir/AppRun << 'APPRUN'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin:${PATH}"
          export LD_LIBRARY_PATH="${HERE}/usr/bin/lib:${LD_LIBRARY_PATH}"
          exec "${HERE}/usr/bin/swaloka_looping_tool" "$@"
          APPRUN
          chmod +x AppDir/AppRun

          # Build AppImage
          ARCH=x86_64 ./appimagetool AppDir "build/Swaloka-Looping-Tool-${VERSION}-linux-x64.AppImage"

      - name: Upload Linux archive artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-archive
          path: |
            build/Swaloka-Looping-Tool-*-linux-x64.tar.gz
            build/Swaloka-Looping-Tool-*-linux-x64.AppImage
          retention-days: 1

  upload-assets:
    name: Upload Release Assets
    needs: [release-please, build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest

    steps:
      - name: Download macOS ZIP
        uses: actions/download-artifact@v4
        with:
          name: macos-zip
          path: ./artifacts

      - name: Download Windows installer
        uses: actions/download-artifact@v4
        with:
          name: windows-installer
          path: ./artifacts

      - name: Download Linux archive
        uses: actions/download-artifact@v4
        with:
          name: linux-archive
          path: ./artifacts

      - name: Upload assets to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ needs.release-please.outputs.tag_name }} ./artifacts/* --repo ${{ github.repository }}

      - name: Output release info
        run: |
          echo "âœ… Release assets uploaded for ${{ needs.release-please.outputs.tag_name }}"
          echo "ðŸ”— https://github.com/${{ github.repository }}/releases/tag/${{ needs.release-please.outputs.tag_name }}"
          echo ""
          echo "ðŸ“¦ Files uploaded:"
          ls -lh ./artifacts/
