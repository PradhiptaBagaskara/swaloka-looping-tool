name: Release

on:
  push:
    branches: [main, develop]
  # Also allow manual releases
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    name: Create Release PR
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.major }}.${{ steps.release.outputs.minor }}.${{ steps.release.outputs.patch }}
      is_prerelease: ${{ github.ref == 'refs/heads/develop' }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          target-branch: ${{ github.ref_name }}

  build-macos:
    name: Build macOS App
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    uses: ./.github/workflows/build-macos.yml
    with:
      artifact-name: macos-archive
      version: ${{ needs.release-please.outputs.version }}

  build-windows:
    name: Build Windows App
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    uses: ./.github/workflows/build-windows.yml
    with:
      artifact-name: windows-installer
      version: ${{ needs.release-please.outputs.version }}

  build-linux:
    name: Build Linux App
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    uses: ./.github/workflows/build-linux.yml
    with:
      artifact-name: linux-archive
      version: ${{ needs.release-please.outputs.version }}

  upload-assets:
    name: Upload Release Assets
    needs: [release-please, build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest

    steps:
      - name: Download macOS archive
        uses: actions/download-artifact@v4
        with:
          name: macos-archive
          path: ./artifacts

      - name: Download Windows installer
        uses: actions/download-artifact@v4
        with:
          name: windows-installer
          path: ./artifacts

      - name: Download Linux archive
        uses: actions/download-artifact@v4
        with:
          name: linux-archive
          path: ./artifacts

      - name: Upload assets to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ needs.release-please.outputs.tag_name }} ./artifacts/* --repo ${{ github.repository }}

      - name: Mark as prerelease (beta)
        if: ${{ needs.release-please.outputs.is_prerelease == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release edit ${{ needs.release-please.outputs.tag_name }} --prerelease --repo ${{ github.repository }}

      - name: Output release info
        run: |
          RELEASE_TYPE="${{ needs.release-please.outputs.is_prerelease == 'true' && 'ðŸ§ª Beta' || 'ðŸš€ Stable' }}"
          echo "âœ… ${RELEASE_TYPE} release assets uploaded for ${{ needs.release-please.outputs.tag_name }}"
          echo "ðŸ”— https://github.com/${{ github.repository }}/releases/tag/${{ needs.release-please.outputs.tag_name }}"
          echo ""
          echo "ðŸ“¦ Files uploaded:"
          ls -lh ./artifacts/
