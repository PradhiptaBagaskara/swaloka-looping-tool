name: Automated Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0

jobs:
  build-macos:
    name: Build macOS App
    runs-on: macos-latest

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Generate app icons
        run: dart run flutter_launcher_icons

      - name: Build macOS app
        run: flutter build macos --release

      - name: Create ZIP
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}

          # Find the app bundle
          APP_PATH=$(find build/macos/Build/Products/Release -name "*.app" -type d -maxdepth 1 | head -n 1)
          APP_NAME=$(basename "$APP_PATH")
          echo "Using app at: $APP_PATH"

          # Create ZIP from app bundle
          cd "$(dirname "$APP_PATH")"
          zip -r "Swaloka-Looping-Tool-${VERSION}-macos.zip" "$APP_NAME"
          mv "Swaloka-Looping-Tool-${VERSION}-macos.zip" "${GITHUB_WORKSPACE}/build/"

      - name: Upload ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-zip
          path: build/Swaloka-Looping-Tool-*-macos.zip
          retention-days: 1

  build-windows:
    name: Build Windows App
    runs-on: windows-latest

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Generate app icons
        run: dart run flutter_launcher_icons

      - name: Build Windows app
        run: flutter build windows --release

      - name: Download VC++ Redistributable
        run: |
          # Download Microsoft Visual C++ Redistributable (required for FFmpeg and native libs)
          Invoke-WebRequest -Uri "https://aka.ms/vs/17/release/vc_redist.x64.exe" -OutFile "windows/vc_redist.x64.exe"
          Write-Host "âœ… Downloaded VC++ Redistributable"

      - name: Create EXE installer with Inno Setup
        run: |
          $VERSION = "${{ github.ref }}".Replace("refs/tags/v", "")

          # Update version in installer script
          $issContent = Get-Content "windows/installer_script.iss" -Raw
          $issContent = $issContent -replace "AppVersion=.*", "AppVersion=$VERSION"
          $issContent = $issContent -replace "OutputBaseFilename=.*", "OutputBaseFilename=Swaloka-Looping-Tool-$VERSION-windows-installer"
          Set-Content "windows/installer_script.iss" $issContent

          # Build installer using Inno Setup
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "windows\installer_script.iss"

          # Move installer to build folder
          Move-Item "Swaloka-Looping-Tool-$VERSION-windows-installer.exe" "build/"

      - name: Upload EXE installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: build/Swaloka-Looping-Tool-*-windows-installer.exe
          retention-days: 1

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-macos, build-windows]

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for changelog

      - name: Extract changelog for this version
        id: changelog
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}

          # Extract section for this version from CHANGELOG.md
          CHANGELOG=$(awk "/## \[$VERSION\]/,/## \[/" CHANGELOG.md | sed '1d;$d')

          # If changelog is empty, use commits since last tag
          if [ -z "$CHANGELOG" ]; then
            PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
            if [ -z "$PREV_TAG" ]; then
              CHANGELOG=$(git log --pretty=format:"- %s (%h)" HEAD)
            else
              CHANGELOG=$(git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD)
            fi
          fi

          # Save to file for multiline content
          echo "$CHANGELOG" > changelog_content.md

      - name: Download macOS ZIP
        uses: actions/download-artifact@v4
        with:
          name: macos-zip
          path: ./artifacts

      - name: Download Windows installer
        uses: actions/download-artifact@v4
        with:
          name: windows-installer
          path: ./artifacts

      - name: Create Release with all files
        uses: softprops/action-gh-release@v1
        with:
          name: Swaloka Looping Tool ${{ github.ref_name }}
          body_path: changelog_content.md
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          generate_release_notes: true
          files: |
            ./artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Output release info
        run: |
          echo "âœ… Release created for version ${GITHUB_REF#refs/tags/}"
          echo "ðŸ”— https://github.com/${{ github.repository }}/releases/tag/${GITHUB_REF#refs/tags/}"
          echo ""
          echo "ðŸ“¦ Files uploaded:"
          ls -lh ./artifacts/
