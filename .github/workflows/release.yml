name: Automated Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0

jobs:
  check-branch:
    name: Check Branch
    runs-on: ubuntu-latest
    outputs:
      is_dev: ${{ steps.check.outputs.is_dev }}
      branch: ${{ steps.check.outputs.branch }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if tag is on dev branch
        id: check
        run: |
          # Get the branch containing this tag
          BRANCH=$(git branch -r --contains ${{ github.ref }} | grep -v HEAD | head -1 | sed 's/.*\///')
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

          # Check if it's dev branch
          if [[ "$BRANCH" == "dev" ]]; then
            echo "is_dev=true" >> $GITHUB_OUTPUT
            echo "ðŸ”§ Dev branch detected - will only upload artifacts"
          else
            echo "is_dev=false" >> $GITHUB_OUTPUT
            echo "ðŸš€ Production branch detected - will create full release"
          fi
  build-macos:
    name: Build macOS App
    runs-on: macos-latest
    needs: check-branch

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Generate app icons
        run: dart run flutter_launcher_icons

      - name: Build macOS app
        run: flutter build macos --release

      - name: Create ZIP
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}

          # Find the app bundle
          APP_PATH=$(find build/macos/Build/Products/Release -name "*.app" -type d -maxdepth 1 | head -n 1)
          APP_NAME=$(basename "$APP_PATH")
          echo "Using app at: $APP_PATH"

          # Create ZIP from app bundle
          cd "$(dirname "$APP_PATH")"
          zip -r "Swaloka-Looping-Tool-${VERSION}-macos.zip" "$APP_NAME"
          mv "Swaloka-Looping-Tool-${VERSION}-macos.zip" "${GITHUB_WORKSPACE}/build/"

      - name: Upload ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-zip
          path: build/Swaloka-Looping-Tool-*-macos.zip
          retention-days: 1

  build-windows:
    name: Build Windows App
    runs-on: windows-latest
    needs: check-branch

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Generate app icons
        run: dart run flutter_launcher_icons

      - name: Build Windows app
        run: flutter build windows --release

      - name: Download 7-Zip SFX Module
        run: |
          Write-Host "ðŸ“¥ Downloading 7-Zip LZMA SDK..." -ForegroundColor Cyan
          Invoke-WebRequest -Uri "https://www.7-zip.org/a/lzma2501.7z" -OutFile "lzma_sdk.7z"

          # Extract the SDK using 7z (should be available in GitHub Actions Windows runner)
          & "C:\Program Files\7-Zip\7z.exe" x lzma_sdk.7z -o"lzma_sdk" -y

          Write-Host "âœ… Downloaded and extracted 7-Zip SFX module" -ForegroundColor Green

      - name: Create Single-File Portable EXE with 7-Zip SFX
        run: |
          $VERSION = "${{ github.ref }}".Replace("refs/tags/v", "")
          $APP_NAME = "Swaloka-Looping-Tool"
          $BUILD_DIR = "build/windows/x64/runner/Release"
          $TEMP_DIR = "portable_temp"

          Write-Host "ðŸ”¨ Building Single-File Portable Executable with 7-Zip SFX..." -ForegroundColor Cyan

          # Create temp directory and copy files
          New-Item -ItemType Directory -Path $TEMP_DIR -Force | Out-Null
          Copy-Item -Path "$BUILD_DIR/*" -Destination $TEMP_DIR -Recurse -Force

          # Create README
          @"
          Swaloka Looping Tool - Portable Version
          ========================================

          FIRST RUN:
          1. Make sure FFmpeg is installed:
             - Using Chocolatey: choco install ffmpeg
             - Using Scoop: scoop install ffmpeg
             - Or download from: https://www.gyan.dev/ffmpeg/builds/

          2. Double-click this EXE to run - it will extract and launch automatically

          FEATURES:
          - Single executable file
          - Run from anywhere (USB drive, etc.)
          - No installation required

          For more: https://github.com/pradhiptabagaskara/swaloka-looping-tool
          "@ | Out-File -FilePath "$TEMP_DIR/README.txt" -Encoding UTF8

          # Create output directory
          $OUTPUT = "build/$APP_NAME-$VERSION-windows-portable.exe"
          New-Item -ItemType Directory -Path "build" -Force | Out-Null

          # Create 7z archive from the portable temp directory
          Write-Host "ðŸ“¦ Creating 7z archive..." -ForegroundColor Cyan
          $ARCHIVE = "portable.7z"
          & "C:\Program Files\7-Zip\7z.exe" a -t7z $ARCHIVE "$TEMP_DIR\*" -mx9

          if (-not (Test-Path $ARCHIVE)) {
            Write-Host "âŒ Failed to create 7z archive" -ForegroundColor Red
            exit 1
          }

          # Find the SFX module (try multiple possible locations)
          Write-Host "ðŸ” Looking for SFX module..." -ForegroundColor Cyan
          $SFX_MODULE = $null
          $possiblePaths = @(
            "lzma_sdk\bin\7zS2con.sfx",
            "lzma_sdk\bin\7zSD.sfx",
            "lzma_sdk\bin\7zS2.sfx",
            "lzma_sdk\CPP\7zip\Bundles\SFXCon\Release\7zS2con.sfx"
          )

          foreach ($path in $possiblePaths) {
            if (Test-Path $path) {
              $SFX_MODULE = $path
              break
            }
          }

          if (-not $SFX_MODULE) {
            Write-Host "âŒ SFX module not found. Available files:" -ForegroundColor Red
            Get-ChildItem "lzma_sdk" -Recurse -Filter "*.sfx" -ErrorAction SilentlyContinue
            Get-ChildItem "lzma_sdk" -Recurse -Filter "7z*.exe" -ErrorAction SilentlyContinue
            exit 1
          }

          Write-Host "âœ… Using SFX module: $SFX_MODULE" -ForegroundColor Green

          # Get the SFX config file (use absolute path)
          $SFX_CONFIG = (Resolve-Path "windows/sfx_config.txt").Path

          # Create the self-extracting executable by concatenating:
          # 1. SFX module binary
          # 2. Config file
          # 3. 7z archive
          Write-Host "ðŸ“¦ Creating self-extracting executable..." -ForegroundColor Cyan

          # Use copy command to concatenate binary files (this works better on Windows)
          cmd /c "copy /b `"$SFX_MODULE`"+`"$SFX_CONFIG`"+`"$ARCHIVE`" `"$OUTPUT`"" 2>&1

          if ($LASTEXITCODE -ne 0) {
            Write-Host "âš ï¸  Copy command returned exit code: $LASTEXITCODE" -ForegroundColor Yellow
          }

          # Verify output was created
          if (Test-Path $OUTPUT) {
            $FileSize = (Get-Item $OUTPUT).Length / 1MB
            Write-Host "âœ… Portable EXE created successfully!" -ForegroundColor Green
            Write-Host "   Location: $OUTPUT" -ForegroundColor Cyan
            Write-Host "   Size: $([math]::Round($FileSize, 2)) MB" -ForegroundColor Cyan
          } else {
            Write-Host "âŒ Output file not created: $OUTPUT" -ForegroundColor Red
            exit 1
          }

          # Cleanup
          Write-Host "ðŸ§¹ Cleaning up temporary files..." -ForegroundColor Cyan
          try {
            Remove-Item -Path $TEMP_DIR -Recurse -Force -ErrorAction Stop
            Write-Host "   âœ“ Removed $TEMP_DIR" -ForegroundColor Gray
          } catch {
            Write-Host "   âš ï¸  Could not remove $TEMP_DIR" -ForegroundColor Yellow
          }

          try {
            Remove-Item $ARCHIVE -Force -ErrorAction Stop
            Write-Host "   âœ“ Removed $ARCHIVE" -ForegroundColor Gray
          } catch {
            Write-Host "   âš ï¸  Could not remove $ARCHIVE" -ForegroundColor Yellow
          }

          try {
            Remove-Item "lzma_sdk" -Recurse -Force -ErrorAction Stop
            Write-Host "   âœ“ Removed lzma_sdk" -ForegroundColor Gray
          } catch {
            Write-Host "   âš ï¸  Could not remove lzma_sdk" -ForegroundColor Yellow
          }

          try {
            Remove-Item "lzma_sdk.7z" -Force -ErrorAction Stop
            Write-Host "   âœ“ Removed lzma_sdk.7z" -ForegroundColor Gray
          } catch {
            Write-Host "   âš ï¸  Could not remove lzma_sdk.7z" -ForegroundColor Yellow
          }

          Write-Host "âœ… Cleanup completed" -ForegroundColor Green

      - name: Download VC++ Redistributable
        run: |
          # Download Microsoft Visual C++ Redistributable (required for FFmpeg and native libs)
          Invoke-WebRequest -Uri "https://aka.ms/vs/17/release/vc_redist.x64.exe" -OutFile "windows/vc_redist.x64.exe"
          Write-Host "âœ… Downloaded VC++ Redistributable"

      - name: Create EXE installer with Inno Setup
        run: |
          $VERSION = "${{ github.ref }}".Replace("refs/tags/v", "")

          # Update version in installer script
          $issContent = Get-Content "windows/installer_script.iss" -Raw
          $issContent = $issContent -replace "AppVersion=.*", "AppVersion=$VERSION"
          $issContent = $issContent -replace "OutputBaseFilename=.*", "OutputBaseFilename=Swaloka-Looping-Tool-$VERSION-windows-installer"
          Set-Content "windows/installer_script.iss" $issContent

          # Build installer using Inno Setup
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "windows\installer_script.iss"

          # Move installer to build folder
          Move-Item "Swaloka-Looping-Tool-$VERSION-windows-installer.exe" "build/"

      - name: Upload Portable EXE artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-portable
          path: build/Swaloka-Looping-Tool-*-windows-portable.exe
          retention-days: 1

      - name: Upload EXE installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: build/Swaloka-Looping-Tool-*-windows-installer.exe
          retention-days: 1

  build-linux:
    name: Build Linux App
    runs-on: ubuntu-latest
    needs: check-branch

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev libfuse2

      - name: Install dependencies
        run: flutter pub get

      - name: Generate app icons
        run: dart run flutter_launcher_icons

      - name: Build Linux app
        run: flutter build linux --release

      - name: Create AppImage (Single File)
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          APP_NAME="Swaloka-Looping-Tool"
          BUILD_DIR="build/linux/x64/release/bundle"
          APPDIR="AppDir"

          echo "ðŸ”¨ Building AppImage for $APP_NAME v$VERSION..."

          # Create AppDir structure
          mkdir -p "$APPDIR/usr/bin"
          mkdir -p "$APPDIR/usr/lib"
          mkdir -p "$APPDIR/usr/share/applications"
          mkdir -p "$APPDIR/usr/share/icons/hicolor/256x256/apps"

          # Copy application files
          cp -r "$BUILD_DIR"/* "$APPDIR/usr/bin/"

          # Create desktop entry
          cat > "$APPDIR/swaloka_looping_tool.desktop" <<EOF
          [Desktop Entry]
          Name=Swaloka Looping Tool
          Exec=swaloka_looping_tool
          Icon=swaloka_looping_tool
          Type=Application
          Categories=AudioVideo;Video;
          Comment=Automate video production with looping backgrounds
          Terminal=false
          EOF

          cp "$APPDIR/swaloka_looping_tool.desktop" "$APPDIR/usr/share/applications/"

          # Copy icon
          if [ -f "assets/logo.png" ]; then
            cp "assets/logo.png" "$APPDIR/swaloka_looping_tool.png"
            cp "assets/logo.png" "$APPDIR/usr/share/icons/hicolor/256x256/apps/swaloka_looping_tool.png"
          fi

          # Create AppRun script
          cat > "$APPDIR/AppRun" <<'APPRUN'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin/:${PATH:+:$PATH}"
          export LD_LIBRARY_PATH="${HERE}/usr/lib/:${HERE}/usr/lib/x86_64-linux-gnu/:${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}"
          export XDG_DATA_DIRS="${HERE}/usr/share/${XDG_DATA_DIRS:+:$XDG_DATA_DIRS}"
          EXEC="${HERE}/usr/bin/swaloka_looping_tool"
          exec "${EXEC}" "$@"
          APPRUN
          chmod +x "$APPDIR/AppRun"

          # Download appimagetool
          wget -q "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage"
          chmod +x appimagetool-x86_64.AppImage

          # Build AppImage
          ARCH=x86_64 ./appimagetool-x86_64.AppImage "$APPDIR" "$APP_NAME-$VERSION-x86_64.AppImage"
          chmod +x "$APP_NAME-$VERSION-x86_64.AppImage"

          # Move to build directory
          mkdir -p build/appimage
          mv "$APP_NAME-$VERSION-x86_64.AppImage" "build/appimage/"

          echo "âœ… AppImage created: build/appimage/$APP_NAME-$VERSION-x86_64.AppImage"

      - name: Create tar.gz archive (Alternative)
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          cd build/linux/x64/release/bundle
          tar -czf "Swaloka-Looping-Tool-${VERSION}-linux-x64.tar.gz" *
          mv "Swaloka-Looping-Tool-${VERSION}-linux-x64.tar.gz" "${GITHUB_WORKSPACE}/build/"

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: build/appimage/Swaloka-Looping-Tool-*-x86_64.AppImage
          retention-days: 1

      - name: Upload tar.gz archive artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-archive
          path: build/Swaloka-Looping-Tool-*-linux-x64.tar.gz
          retention-days: 1

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [check-branch, build-macos, build-windows, build-linux]
    # Only create release if NOT on dev branch
    if: needs.check-branch.outputs.is_dev != 'true'

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for changelog

      - name: Extract changelog for this version
        id: changelog
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}

          # Extract section for this version from CHANGELOG.md
          CHANGELOG=$(awk "/## \[$VERSION\]/,/## \[/" CHANGELOG.md | sed '1d;$d')

          # If changelog is empty, use commits since last tag
          if [ -z "$CHANGELOG" ]; then
            PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
            if [ -z "$PREV_TAG" ]; then
              CHANGELOG=$(git log --pretty=format:"- %s (%h)" HEAD)
            else
              CHANGELOG=$(git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD)
            fi
          fi

          # Save to file for multiline content
          echo "$CHANGELOG" > changelog_content.md

      - name: Download macOS ZIP
        uses: actions/download-artifact@v4
        with:
          name: macos-zip
          path: ./artifacts

      - name: Download Windows portable EXE
        uses: actions/download-artifact@v4
        with:
          name: windows-portable
          path: ./artifacts

      - name: Download Windows installer
        uses: actions/download-artifact@v4
        with:
          name: windows-installer
          path: ./artifacts

      - name: Download Linux AppImage
        uses: actions/download-artifact@v4
        with:
          name: linux-appimage
          path: ./artifacts

      - name: Download Linux archive
        uses: actions/download-artifact@v4
        with:
          name: linux-archive
          path: ./artifacts

      - name: Create Release with all files
        uses: softprops/action-gh-release@v1
        with:
          name: Swaloka Looping Tool ${{ github.ref_name }}
          body_path: changelog_content.md
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          generate_release_notes: true
          files: |
            ./artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Output release info
        run: |
          echo "âœ… Release created for version ${GITHUB_REF#refs/tags/}"
          echo "ðŸ”— https://github.com/${{ github.repository }}/releases/tag/${GITHUB_REF#refs/tags/}"
          echo ""
          echo "ðŸ“¦ Files uploaded:"
          ls -lh ./artifacts/

  dev-build-summary:
    name: Dev Build Summary
    runs-on: ubuntu-latest
    needs: [check-branch, build-macos, build-windows, build-linux]
    # Only run this if on dev branch
    if: needs.check-branch.outputs.is_dev == 'true'

    permissions:
      contents: read

    steps:
      - name: Dev build completed
        run: |
          echo "ðŸ”§ Dev Build Summary"
          echo "===================="
          echo ""
          echo "âœ… All builds completed successfully for dev branch!"
          echo "ðŸ“¦ Version: ${GITHUB_REF#refs/tags/}"
          echo "ðŸŒ¿ Branch: ${{ needs.check-branch.outputs.branch }}"
          echo ""
          echo "ðŸ“¥ Artifacts uploaded to GitHub Actions:"
          echo "   - macos-zip"
          echo "   - windows-portable"
          echo "   - windows-installer"
          echo "   - linux-appimage"
          echo "   - linux-archive"
          echo ""
          echo "ðŸ’¡ To download artifacts:"
          echo "   1. Go to Actions tab"
          echo "   2. Click on this workflow run"
          echo "   3. Scroll down to 'Artifacts' section"
          echo ""
          echo "ðŸš€ To create a production release:"
          echo "   1. Merge dev to main"
          echo "   2. Tag on main branch"
          echo "   3. Full release will be created automatically"
