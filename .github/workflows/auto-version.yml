name: Auto Version Bump

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'test/**'
      - 'tests/**'
      - '**_test.dart'
      - 'LICENSE'
      - '.gitignore'
      - 'CHANGELOG.md'

jobs:
  version-bump:
    name: Auto Bump Version
    runs-on: ubuntu-latest

    # Grant permissions for pushing commits and tags
    permissions:
      contents: write

    # Skip if commit message contains [skip-version] or starts with 'chore: bump version'
    if: "!contains(github.event.head_commit.message, '[skip-version]') && !startsWith(github.event.head_commit.message, 'chore: bump version')"

    steps:
      - name: Setup SSH for git operations
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for version detection
          ssh-key: ${{ secrets.DEPLOY_KEY }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check if version bump is needed
        id: check_bump
        run: |
          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            COMMITS=$(git log --pretty=format:"%s" HEAD~1..HEAD)
          else
            COMMITS=$(git log --pretty=format:"%s" "$LAST_TAG"..HEAD)
          fi

          echo "Commits to analyze:"
          echo "$COMMITS"

          # Check if only docs/test commits (skip version bump)
          if echo "$COMMITS" | grep -qvE "^(docs|test)(\(.+\))?:"; then
            echo "needs_bump=true" >> $GITHUB_OUTPUT
            echo "âœ… Version bump needed"
          else
            echo "needs_bump=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  Only docs/test commits, skipping version bump"
          fi

      - name: Run version bump script
        if: steps.check_bump.outputs.needs_bump == 'true'
        run: |
          chmod +x scripts/bump_version.sh
          ./scripts/bump_version.sh

      - name: Push changes and tag
        if: steps.check_bump.outputs.needs_bump == 'true'
        run: |
          # Get the new version tag
          NEW_TAG=$(git describe --tags --abbrev=0)

          echo "ğŸ“¦ New version: $NEW_TAG"

          # Push the commit
          echo "Pushing commit to main..."
          git push origin main || { echo "âŒ Failed to push commit"; exit 1; }

          # Push the tag (this will trigger the release workflow)
          echo "Pushing tag $NEW_TAG..."
          git push origin "$NEW_TAG" || { echo "âŒ Failed to push tag"; exit 1; }

          echo "âœ… Pushed version bump and tag to trigger release"

      - name: Summary
        if: steps.check_bump.outputs.needs_bump == 'true'
        run: |
          NEW_TAG=$(git describe --tags --abbrev=0)
          echo "ğŸ‰ Auto-versioning complete!"
          echo "ğŸ“¦ New version: $NEW_TAG"
          echo "ğŸš€ Release workflow will be triggered automatically"
